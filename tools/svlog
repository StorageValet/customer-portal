#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"
mkdir -p "$REPO_ROOT/.sv"
LOG=".sv/term.log"

cmd="${1:-status}"

is_running() {
  pgrep -f "script -q -f $LOG" >/dev/null 2>&1
}

case "$cmd" in
  start)
    if is_running; then
      echo "svlog: already running → $LOG"
      exit 0
    fi
    echo "svlog: starting recorder → $LOG"
    # Start a persistent recorder for this shell session
    nohup script -q -f "$LOG" </dev/tty >/dev/tty 2>&1 &
    sleep 0.2
    ;;
  stop)
    if is_running; then
      pkill -f "script -q -f $LOG" || true
      echo "svlog: stopped"
    else
      echo "svlog: not running"
    fi
    ;;
  status)
    if is_running; then
      echo "svlog: RUNNING → $LOG"
    else
      echo "svlog: stopped"
    fi
    ;;
  tail)
    [ -f "$LOG" ] || { echo "svlog: no log yet ($LOG)"; exit 0; }
    tail -f "$LOG"
    ;;
  *)
    echo "Usage: tools/svlog {start|stop|status|tail}"
    exit 1
    ;;
esac